// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                 String   @id @default(cuid())
  fid                BigInt   @unique

  username           String?  @unique
  displayName        String?  @map("display_name")
  pfpUrl             String?  @map("pfp_url")

  primaryEthAddress  String?  @map("primary_eth_address") @db.VarChar(42)

  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")
  lastActiveAt       DateTime @default(now()) @map("last_active_at")

  // Login Streak
  currentLoginStreak Int      @default(0) @map("current_login_streak")
  maxLoginStreak     Int      @default(0) @map("max_login_streak")
  lastLoginDate      DateTime? @map("last_login_date")

  // Win Streak
  currentWinStreak   Int      @default(0) @map("current_win_streak")
  maxWinStreak       Int      @default(0) @map("max_win_streak")

  // Relations
  trades             TradeActivity[]
  userDailyStats     UserDailyStats[]

  @@index([fid])
  @@index([primaryEthAddress])
  @@map("users")
  userStats          UserStats[]
}

// Option B: Persistent User Stats for Leaderboard
model UserStats {
  id              String    @id @default(uuid())
  userId          String    @map("user_id")
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  period          String    @db.VarChar(16)
  
  // Aggregated Stats (Decimal for accuracy)
  totalPnl        Decimal   @default(0) @db.Decimal(20, 8)
  totalRoiPercent Decimal   @default(0) @db.Decimal(10, 2)
  totalVolume     Decimal   @default(0) @db.Decimal(20, 8)
  totalTrades     Int       @default(0)
  winCount        Int       @default(0)
  winRate         Decimal   @default(0) @db.Decimal(5, 2)
  
  updatedAt       DateTime  @updatedAt @map("updated_at")

  @@unique([userId, period])
  @@index([period, totalPnl(sort: Desc)])
  @@index([period, totalRoiPercent(sort: Desc)])
  @@index([period, totalVolume(sort: Desc)])
  @@index([period, winRate(sort: Desc)])

  @@map("user_stats")
}

// Bucketed daily stats to support rolling leaderboards without cache
model UserDailyStats {
  id              String    @id @default(uuid())
  userId          String    @map("user_id")
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  dateUtc         DateTime  @map("date_utc")

  totalPnl        Decimal   @default(0) @db.Decimal(20, 8)
  totalRoiPercent Decimal   @default(0) @db.Decimal(10, 2)
  totalVolume     Decimal   @default(0) @db.Decimal(20, 8)
  totalTrades     Int       @default(0)
  winCount        Int       @default(0)
  winRate         Decimal   @default(0) @db.Decimal(5, 2)

  updatedAt       DateTime  @updatedAt @map("updated_at")

  @@unique([userId, dateUtc])
  @@index([userId, dateUtc])
  @@index([dateUtc])
  @@index([dateUtc, totalPnl(sort: Desc)])

  @@map("user_daily_stats")
}

/// Trade status enum
enum TradeStatus {
  OPEN
  SETTLED
  EXPIRED
}

/// Trade activity model for storing user's Thetanuts positions
model TradeActivity {
  id              String      @id @default(cuid())
  userId          String      @map("user_id")
  user            User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  optionAddress   String      @map("option_address")      // Deployed option contract
  txHash          String      @unique @map("tx_hash")     // Entry transaction hash (unique)
  status          TradeStatus @default(OPEN)
  underlyingAsset   String    @map("underlying_asset")    // "BTC" | "ETH"
  optionType        String    @map("option_type")         // "CALL_SPREAD" | "PUT_BUTTERFLY" etc (derived)
  optionTypeRaw     Int       @map("option_type_raw")     // Raw bitmask from API (256, 257, etc)
  isCall            Boolean   @map("is_call")             // Derived from optionTypeRaw (bit 0)
  isLong            Boolean   @map("is_long")             // Derived from optionTypeRaw (bit 8)
  strikes           Json                                   // Array of strike prices
  expiryTimestamp   DateTime  @map("expiry_timestamp")    // When option expires
  buyer             String                                 // Buyer wallet address
  seller            String                                 // Seller wallet address (market maker)
  referrer          String?                                // Referrer address (Alphabit's address)
  createdBy         String?   @map("created_by")          // Factory contract that created option
  collateralToken     String  @map("collateral_token")    // USDC contract address
  collateralSymbol    String  @map("collateral_symbol")   // "USDC"
  collateralDecimals  Int     @map("collateral_decimals") // 6 for USDC
  priceFeed           String? @map("price_feed")          // Oracle contract address
  entryPremium      String    @map("entry_premium")       // Premium paid by buyer
  entryFeePaid      String    @map("entry_fee_paid")      // Protocol fee paid
  numContracts      String    @map("num_contracts")       // Number of contracts
  collateralAmount  String    @map("collateral_amount")   // Total collateral locked
  entryTimestamp    DateTime  @map("entry_timestamp")     // When trade was made
  entryBlock        Int?      @map("entry_block")         // Block number of entry tx
  settlementPrice           String?   @map("settlement_price")            // Oracle price at expiry
  payoutBuyer               String?   @map("payout_buyer")                // Amount paid to buyer (if ITM)
  collateralReturnedSeller  String?   @map("collateral_returned_seller")  // Amount returned to seller
  exercised                 Boolean?  @map("exercised")                   // Was option exercised?
  closeTimestamp    DateTime? @map("close_timestamp")     // When position was closed/settled
  closeTxHash       String?   @map("close_tx_hash")       // Settlement transaction hash
  closeBlock        Int?      @map("close_block")         // Block number of close tx
  oracleFailure       Boolean?  @map("oracle_failure") @default(false)
  oracleFailureReason String?   @map("oracle_failure_reason")
  explicitClose     Json?     @map("explicit_close")      // Raw data if manually closed
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")
  

  // Analytics Data (Decimal fields for calculation/sorting)
  pnl             Decimal?  @db.Decimal(20, 8) // Profit/Loss in USD (payout - premium)
  roiPercent      Decimal?  @db.Decimal(10, 2) // ROI in % ((payout - premium) / premium * 100)
  normalizedVolume Decimal? @db.Decimal(20, 8) // Collateral amount as number
  
  @@index([userId, createdAt(sort: Desc)])          // User's trade history
  @@index([userId, status])                         // User's open/settled positions
  @@index([status, expiryTimestamp])                // Expiry monitoring
  @@index([optionAddress])                          // Lookup by option contract
  @@index([txHash])                                 // Lookup by entry tx
  @@index([closeTxHash])                            // Lookup by close tx
  @@index([referrer])                               // Referrer analytics
  @@index([underlyingAsset, status])                // BTC/ETH position filtering
  @@index([userId, closeTimestamp])                 // PnL history filtering
  @@index([userId, entryTimestamp])                 // Distribution filtering
  @@index([userId, pnl])                            // Leaderboard sorting
  @@index([userId, roiPercent])                     // Leaderboard sorting
  @@index([userId, normalizedVolume])               // Leaderboard sorting (Volume)
  
  @@map("trade_activities")
}

/// Configuration table for dynamic application settings
model Config {
  id          String   @id @default(cuid())
  key         String   @unique
  value       String   @db.Text
  description String?
  
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("configs")
}
